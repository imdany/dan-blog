<!DOCTYPE html>



<html lang="en-US" 
  
    mode="light"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Why you should start writing Spark Custom Native Functions" />
<meta name="author" content="Daniel González Pérez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." />
<meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." />
<link rel="canonical" href="https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4" />
<meta property="og:url" content="https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4" />
<meta property="og:site_name" content="Dan’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-04T01:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Why you should start writing Spark Custom Native Functions" />
<meta name="twitter:site" content="@twitter_username" />
<meta name="twitter:creator" content="@Daniel González Pérez" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4","headline":"Why you should start writing Spark Custom Native Functions","datePublished":"2021-08-04T01:00:00+01:00","dateModified":"2021-08-04T01:00:00+01:00","author":{"@type":"Person","name":"Daniel González Pérez"},"description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","mainEntityOfPage":{"@type":"WebPage","@id":"https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Why you should start writing Spark Custom Native Functions | Dan's Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Dan's Blog">
<meta name="application-name" content="Dan's Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Why you should start writing Spark Custom Native Functions | Dan’s Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Why you should start writing Spark Custom Native Functions" />
<meta name="author" content="Daniel González Pérez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." />
<meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." />
<link rel="canonical" href="https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4" />
<meta property="og:url" content="https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4" />
<meta property="og:site_name" content="Dan’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-04T01:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Why you should start writing Spark Custom Native Functions" />
<meta name="twitter:site" content="@twitter_username" />
<meta name="twitter:creator" content="@Daniel González Pérez" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4","headline":"Why you should start writing Spark Custom Native Functions","datePublished":"2021-08-04T01:00:00+01:00","dateModified":"2021-08-04T01:00:00+01:00","author":{"@type":"Person","name":"Daniel González Pérez"},"description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","mainEntityOfPage":{"@type":"WebPage","@id":"https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/avatar1.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Dan's Blog</a>
    </div>

    <div class="site-subtitle font-italic">A personal blog for sharing some ideas.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT ME</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/imdany" aria-label="github"
        
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://www.linkedin.com/in/daniel-gonzalez-perez/" aria-label="linkedin"
        
        target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
        <span>
          
          
          <a href="/">
            Posts
          </a>
        </span>

        

      

        
          <span>Why you should start writing Spark Custom Native Functions</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->




<!-- images -->



  <!-- add CDN prefix if it exists -->

  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

  

  <!-- add image placehoder to prevent layout reflow -->

  

  

  
    
      
      
    

    
    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  
    

    
    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  
    

    
    
    

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    
      
      

      

      

    

    

  

  



<!-- Add lang-badge for code snippets -->




<!-- return -->

<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Why you should start writing Spark Custom Native Functions</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Daniel González Pérez
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Wed, Aug  4, 2021,  1:00 AM +0100"
  

  
  prep="on" >

  
  

  
    Aug  4
  

  <i class="unloaded">2021-08-04T01:00:00+01:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1513 words">8 min</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <hr />

<p><strong>Article originally published at <a href="https://medium.com/version-1/why-you-should-start-writing-spark-custom-native-functions-427372c08b4">Medium.</a></strong></p>

<hr />

<p>One of the first things that people try when they need to do something that doesn’t come out of the box in Spark is to write a UDF, a <strong>User Defined Function</strong>, that allows them to achieve that functionality they’re looking for, but is that the best way of doing it? What are the performance implications of writing a UDF?</p>

<p>This post will be looking at implementing a function that returns a UUID with two different approaches by using a UDF and writing Custom Spark-Native code, and comparing their performance.</p>

<p>Let’s get started!</p>

<hr />

<p>This post will follow the next structure.</p>
<ol>
  <li><strong>Introduction</strong></li>
  <li><strong>A quick preface to UUIDs</strong></li>
  <li><strong>UUID implementation with UDFs</strong></li>
  <li><strong>UUID implementation with Catalyst Expressions</strong></li>
  <li><strong>Performance Comparison</strong></li>
  <li><strong>Conclusion</strong></li>
  <li><strong>Resources</strong></li>
</ol>

<hr />

<p><strong>Note 1</strong>: This will only work using scala. </p>

<p><strong>Note 2</strong>: The <strong>UUID()</strong> function is available in Spark since version 3.0.0, but implementing it is still a useful exercise due to its simplicity. </p>

<p><strong>You can find the code:</strong>  <a href="https://github.com/imdany/spark_catalyst_udf">https://github.com/imdany/spark_catalyst_udf</a></p>

<hr />

<h2 id="1-introduction">1. Introduction</h2>

<p>If you have done some work with Spark, you know that there are cases where Spark itself doesn’t provide the functionality you require, so you need to expand it.</p>

<p>Usually, you can do this by writing a UDF that does the job. But did you know that there is another alternative? They are called <strong>Catalyst Expressions</strong>, and I have to say that they are not straightforward to write, but (spoiler alert) they could bring your application to another level of performance.</p>

<p>So let’s get down to business!</p>

<h2 id="2-a-quick-introduction-to-uuids">2. A quick introduction to UUIDs</h2>

<p>UUID stands for Universally Unique Identifier, and it’s a pretty common way of generating a unique string that can identify a piece of data. There are multitudes of different implementations of this mechanism, but the most regularly used is the UUID Version-4, and the IDs look like this:</p>

<blockquote>
  <p>c896f39a-6001–4e62–9296-a323bee9b047</p>
</blockquote>

<p>The critical point of this version is that the bits that comprise the identifier are generated randomly and with no inherent logic. Because of this, there is no way to identify information about the source by only looking at the UUID.</p>

<p>Another important aspect when generating IDs is called “collisions”, which means having a duplicated string during the generation. Quoting from Wikipedia:</p>

<blockquote>
  <p>“The number of random version-4 UUIDs which need to be generated to <strong>have a 50% probability of at least one collision is 2.71 quintillion…</strong></p>
</blockquote>

<blockquote>
  <p>This number is equivalent to generating <strong>1 billion UUIDs per second for about 85 years</strong>. A file containing this many UUIDs, at 16 bytes per UUID, would be about 45 exabytes.”</p>
</blockquote>

<p>So we can say that it’s implausible that we face this issue.</p>

<p>Java/Scala already has this functionality implemented in the class <strong>java.util.UUID</strong>. This class provides a method called <strong>randomUUID()</strong> (you can take a look at the source code here, <a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/default/src/share/classes/java/util/UUID.java#l141">http://hg.openjdk.java.net/jdk8/…/classes/java/util/UUID.java#l141</a> that generates the UUID for us, but… how do we access that functionality from Spark?</p>

<p>Let’s examine how to implement this UUID generator in Spark using both a UDF and a Catalyst expression approach.</p>

<h2 id="3-uuid-implementation-with-udfs">3. UUID implementation with UDFs</h2>

<p>Implementing a UUID generator using UDFs it’s straightforward, and it’s a piece of code that I have probably seen in all the projects that I have worked on.</p>

<p>With some variations or different syntax, one way that we can write this function is:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.UserDefinedFunction</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.udf</span>

<span class="k">def</span> <span class="nf">uuid</span><span class="k">:</span> <span class="kt">UserDefinedFunction</span> <span class="o">=</span> <span class="nf">udf</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="nv">java</span><span class="o">.</span><span class="py">util</span><span class="o">.</span><span class="py">UUID</span><span class="o">.</span><span class="py">randomUUID</span><span class="o">().</span><span class="py">toString</span><span class="o">)</span>

<span class="nv">spark</span><span class="o">.</span><span class="py">sqlContext</span><span class="o">.</span><span class="py">udf</span><span class="o">.</span><span class="py">register</span><span class="o">(</span><span class="s">"uuid"</span><span class="o">,</span> <span class="n">uuid</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This way, we can use the UUID function either with SQL expressions and with the Dataframe API.</p>

<p>The main point here is that we’re using an existing Java function but not in Spark. To use that from Spark, we can wrap that code around the UDF method Spark provides and then register that UDF if we want to use it in the SQL API.</p>

<p>Easy, right? And you can use this approach for many, many different things. It’s easy to do, and it works, but there are other ways of extending the spark functionality.</p>

<h2 id="4-uuid-implementation-with-catalyst-expressions">4. UUID implementation with Catalyst Expressions</h2>

<p>Writing a catalyst expression can be more complex than a UDF, but as you’ll see in the next section, there are some performance advantages of doing it. Let’s start with the basics, how we write them:</p>

<p>To write a custom function in Spark, we need at least two files: the first one will implement the functionality by extending the Catalyst functionality. The second one will make that function available.</p>

<ul>
  <li>Catalyst Expression</li>
</ul>

<p>The file that contains the implementation of the code needs to be created in a particular package, that is:</p>

<p><strong>org.apache.spark.sql.catalyst.expressions</strong></p>

<p>Therefore, we need to create the file for our function in that folder in our Spark project.</p>

<p><img data-proofer-ignore data-src="/assets/img/posts/2021-07-23-spark-should-use-catalyst-expressions/1.png" alt="Folder Structure" /></p>

<p>And here is when things can get quite elaborated. To make Spark use our functions, we need to extend the available interface. There are many different interfaces that we could implement, and finding the right one can be complex as the documentation around this is not abundant. To simplify things, let’s analyze what we want to achieve - <strong>A function that has no input parameters and returns a string.</strong></p>

<p>I found that I need to implement a <strong>“Leaf Expression”</strong>, so my class will start like this:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">Uuid</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">LeafExpression</span> <span class="k">with</span> <span class="nc">CodegenFallback</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">nullable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span> 
  <span class="k">override</span> <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">InternalRow</span><span class="o">)</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="o">???</span> 
  <span class="k">override</span> <span class="k">def</span> <span class="nf">dataType</span><span class="k">:</span> <span class="kt">DataType</span> <span class="o">=</span> <span class="o">???</span>  
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>So let’s fill that definition, starting with the easy methods:</p>

<p>For dataType, as we want to return a string:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">override</span> <span class="k">def</span> <span class="nf">dataType</span><span class="k">:</span> <span class="kt">DataType</span> <span class="o">=</span> <span class="nc">StringType</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And for the nullable, as we don’t want to return nulls from our function:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">override</span> <span class="k">def</span> <span class="nf">nullable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The last bit, “eval”, is the actual evaluation of the function that will generate the UUIDs.</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">override</span> <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">InternalRow</span><span class="o">)</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="nv">UTF8String</span><span class="o">.</span><span class="py">fromString</span><span class="o">(</span><span class="nv">java</span><span class="o">.</span><span class="py">util</span><span class="o">.</span><span class="py">UUID</span><span class="o">.</span><span class="py">randomUUID</span><span class="o">().</span><span class="py">toString</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>That’s it! The only unusual thing that you may notice is the <strong>UTF8String.fromString().</strong> If you try to run the code without that, you’ll see:</p>

<p><strong>java.lang.ClassCastException: java.lang.String cannot be cast to org.apache.spark.unsafe.types.UTF8String</strong></p>

<p>The reason for calling that method is because Spark uses it to convert an “External String” into a “Spark String” <a href="https://github.com/apache/spark/blob/master/common/unsafe/src/main/java/org/apache/spark/unsafe/types/UTF8String.java#L49">https://github.com/apache/spark/blob/…/apache/spark/unsafe/types/UTF8String.java#L49</a></p>

<p>The final code looks like this:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="nn">org.apache.spark.sql.catalyst.expressions</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.catalyst.InternalRow</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.catalyst.expressions.codegen.CodegenFallback</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types.</span><span class="o">{</span><span class="nc">DataType</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.unsafe.types.UTF8String</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Uuid</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">LeafExpression</span> <span class="k">with</span> <span class="nc">CodegenFallback</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">nullable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">dataType</span><span class="k">:</span> <span class="kt">DataType</span> <span class="o">=</span> <span class="nc">StringType</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">InternalRow</span><span class="o">)</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="nv">UTF8String</span><span class="o">.</span><span class="py">fromString</span><span class="o">(</span><span class="nv">java</span><span class="o">.</span><span class="py">util</span><span class="o">.</span><span class="py">UUID</span><span class="o">.</span><span class="py">randomUUID</span><span class="o">().</span><span class="py">toString</span><span class="o">)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Easy right? Well, in this case, yes, this was an easy implementation, but it’s not typically as easy as this.</p>

<ul>
  <li>Function wrapper</li>
</ul>

<p>Now that we have the catalyst expression written, we need to make it available to the Dataframe API. To do that, we need to create a file. The location of this file is not as important as the previous one, but to get things sorted, I usually put it in: </p>

<p><strong>org.apache.spark.sql</strong></p>

<p><img data-proofer-ignore data-src="/assets/img/posts/2021-07-23-spark-should-use-catalyst-expressions/2.png" alt="Folder Structure" /></p>

<p>And this time, I have called it CustomFunctions, and it needs to define the following content:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">object</span> <span class="nc">CustomFunctions</span> <span class="o">{</span> 
  <span class="k">private</span> <span class="k">def</span> <span class="nf">withExpr</span><span class="o">(</span><span class="n">expr</span><span class="k">:</span> <span class="kt">Expression</span><span class="o">)</span><span class="k">:</span> <span class="kt">Column</span> <span class="o">=</span> <span class="nc">Column</span><span class="o">(</span><span class="n">expr</span><span class="o">)</span> 
  <span class="k">def</span> <span class="nf">UUID_CUSTOM</span><span class="o">()</span><span class="k">:</span> <span class="kt">Column</span> <span class="o">=</span> <span class="n">withExpr</span> <span class="o">{</span> 
    <span class="nc">Uuid</span><span class="o">()</span> 
  <span class="o">}</span> 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>With this code, we’re making available the function <strong>Uuid</strong> through the object CustomFunctions.</p>

<ul>
  <li>Usage</li>
</ul>

<p>The final question is, how do we use this function? The answer is quite easy!</p>

<p>We need to import it as we’ll do with any other function:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">org.apache.spark.sql.CustomFunctions.UUID_CUSTOM</span>
</pre></td></tr></tbody></table></code></div></div>

<p>and use it in our dataframe:</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">.</span><span class="py">withColumn</span><span class="o">(</span><span class="s">"uuid"</span><span class="o">,</span> <span class="nc">UUID_CUSTOM</span><span class="o">())</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="5-performance-comparison">5. Performance Comparison</h2>

<p>The question that you may be asking yourself is, is all of these really worth it? Well, let’s take a look at the numbers.</p>

<p>I have run the same code using the UDF and the catalyst expression on a dataframe with different sizes, and the results are pretty interesting.</p>

<div lang="scala" class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// UDF version</span>
<span class="k">val</span> <span class="nv">data</span> <span class="k">=</span> <span class="nv">spark</span><span class="o">.</span><span class="py">range</span><span class="o">(</span><span class="n">nRows</span><span class="o">).</span><span class="py">toDF</span><span class="o">(</span><span class="s">"ID"</span><span class="o">).</span><span class="py">withColumn</span><span class="o">(</span><span class="s">"uuid_udf"</span><span class="o">,</span> <span class="nf">expr</span><span class="o">(</span><span class="s">"uuid_udf()"</span><span class="o">))</span> 
<span class="nv">data</span><span class="o">.</span><span class="py">write</span><span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="s">"parquet"</span><span class="o">).</span><span class="py">mode</span><span class="o">(</span><span class="s">"overwrite"</span><span class="o">).</span><span class="py">save</span><span class="o">(</span><span class="s">"/tmp/test/UDF/"</span><span class="o">)</span>

<span class="o">--------</span>
<span class="c1">// Catalyst Version</span>
<span class="k">val</span> <span class="nv">data</span> <span class="k">=</span> <span class="nv">spark</span><span class="o">.</span><span class="py">range</span><span class="o">(</span><span class="n">nRows</span><span class="o">).</span><span class="py">toDF</span><span class="o">(</span><span class="s">"ID"</span><span class="o">).</span><span class="py">withColumn</span><span class="o">(</span><span class="s">"uuid"</span><span class="o">,</span> <span class="nc">UUID_CUSTOM</span><span class="o">())</span> 
<span class="nv">data</span><span class="o">.</span><span class="py">write</span><span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="s">"parquet"</span><span class="o">).</span><span class="py">mode</span><span class="o">(</span><span class="s">"overwrite"</span><span class="o">).</span><span class="py">save</span><span class="o">(</span><span class="s">"/tmp/test/catalyst/"</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I have run each function with 4 different numbers of rows and 100 times each combination, and then I got <strong>the average of</strong> those times, and the result is this:</p>

<p><img data-proofer-ignore data-src="/assets/img/posts/2021-07-23-spark-should-use-catalyst-expressions/3.png" alt="Folder Structure" /></p>

<p>For small dataframes, the difference is not very noticeable, but when you increase the size of the dataframe, you can start seeing how the Catalyst expression perform much better than the UDF.</p>

<h2 id="6-conclusion">6. Conclusion</h2>

<p>So should I stop using UDFs and start writing Catalyst expressions?</p>

<p>I cannot answer that for you as it will depend on many different aspects, like time, resources available or knowledge.</p>

<p>But what is clear from <strong>the results of the tests</strong> is that if you need a high performant application or reduce the execution time of your job, you should consider taking a look at how to write these kinds of catalyst expressions.</p>

<h2 id="7-resources">7. Resources</h2>

<p>I haven’t been able to find much documentation regarding Catalyst Expressions and their implementation. So, if you want to deep dive into this, I recommend you to take a look at the spark source code and look for existing functions that achieve a similar thing to what you’re trying to do and implement yours based on that:</p>

<p>Examples:
https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/stringExpressions.scala</p>

<p>https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/arithmetic.scala</p>

<p>Expressions:
https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/Expression.scala</p>

<hr />

<p>Thanks for reading!</p>



      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/spark/'>Spark</a>,
            <a href='/categories/data-engineer/'>Data Engineer</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/spark/"
            class="post-tag no-text-decoration" >Spark</a>
          
          <a href="/tags/performance/"
            class="post-tag no-text-decoration" >Performance</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Why you should start writing Spark Custom Native Functions - Dan's Blog&url=https://blog.imdany.io/posts/spark-should-use-catalyst-expressions/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Why you should start writing Spark Custom Native Functions - Dan's Blog&u=https://blog.imdany.io/posts/spark-should-use-catalyst-expressions/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://blog.imdany.io/posts/spark-should-use-catalyst-expressions/" data-toggle="tooltip" data-placement="top"
          title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin">
          <i class="fa-fw fab fa-linkedin"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  


 <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->

  
</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/spark-intro-geospatial-analytics/" class="btn btn-outline-primary"
    prompt="Older">
    <p>An Introduction to Geospatial Processing with Spark</p>
  </a>
  

  
  <span class="btn btn-outline-primary disabled"
    prompt="Newer">
    <p>-</p>
  </span>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2021
        <a href="https://github.com/imdany">Dan</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/spark/">Spark</a>
      
        
        <a class="post-tag" href="/tags/analytics/">Analytics</a>
      
        
        <a class="post-tag" href="/tags/performance/">Performance</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://blog.imdany.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- common -->

<script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>



<!-- layout specified -->


  



  <!-- image lazy-loading & popup -->
  <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>




  </body>

</html>

